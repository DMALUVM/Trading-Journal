<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Trade Journal</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        #calendar { width: 800px; margin-bottom: 20px; }
        table { border-collapse: collapse; width: 100%; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
        .day-positive { background-color: lightgreen; }
        .day-negative { background-color: lightcoral; }
        .day-zero { background-color: white; }
        .clickable { cursor: pointer; }
        #summaries { width: 300px; border: 1px solid #ddd; padding: 10px; margin-bottom: 20px; }
        #day-view { border: 1px solid #ddd; padding: 10px; }
        #day-view div { margin-bottom: 20px; padding: 10px; border: 1px solid #eee; }
        form { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        form label { display: block; margin-bottom: 5px; }
        form textarea { width: 100%; height: 100px; }
        button { margin-right: 5px; }
    </style>
</head>
<body>
    <h1>Trade Journal</h1>
    <div id="summaries"></div>
    <div id="calendar"></div>
    <div id="day-view"></div>

    <script>
        let trades = JSON.parse(localStorage.getItem('trades')) || {};

        function saveTrades() {
            localStorage.setItem('trades', JSON.stringify(trades));
        }

        let currentYear = new Date().getFullYear();
        let currentMonth = new Date().getMonth();

        function renderCalendar() {
            const calendarDiv = document.getElementById('calendar');
            calendarDiv.innerHTML = '';

            const nav = document.createElement('div');
            nav.style.marginBottom = '10px';

            const prev = document.createElement('button');
            prev.textContent = 'Prev Month';
            prev.onclick = () => {
                currentMonth--;
                if (currentMonth < 0) { currentMonth = 11; currentYear--; }
                renderCalendar();
            };

            const next = document.createElement('button');
            next.textContent = 'Next Month';
            next.onclick = () => {
                currentMonth++;
                if (currentMonth > 11) { currentMonth = 0; currentYear++; }
                renderCalendar();
            };

            const todayBtn = document.createElement('button');
            todayBtn.textContent = 'Today';
            todayBtn.onclick = () => {
                const now = new Date();
                currentMonth = now.getMonth();
                currentYear = now.getFullYear();
                renderCalendar();
            };

            nav.appendChild(prev);
            nav.appendChild(todayBtn);
            nav.appendChild(next);
            calendarDiv.appendChild(nav);

            const table = document.createElement('table');
            const thead = document.createElement('thead');
            const tr = document.createElement('tr');
            ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].forEach(d => {
                const th = document.createElement('th');
                th.textContent = d;
                tr.appendChild(th);
            });
            thead.appendChild(tr);
            table.appendChild(thead);

            const tbody = document.createElement('tbody');
            const firstDay = new Date(currentYear, currentMonth, 1).getDay();
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            let day = 1;
            for (let i = 0; i < 6; i++) {
                const row = document.createElement('tr');
                for (let j = 0; j < 7; j++) {
                    const cell = document.createElement('td');
                    if ((i === 0 && j < firstDay) || day > daysInMonth) {
                        cell.textContent = '';
                    } else {
                        const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                        const dayTrades = trades[dateStr] || [];
                        const count = dayTrades.length;
                        let pl = 0;
                        dayTrades.forEach(t => pl += parseFloat(t.profitLoss) || 0);
                        let className = 'day-zero';
                        if (pl > 0) className = 'day-positive';
                        else if (pl < 0) className = 'day-negative';
                        cell.classList.add(className);
                        if (count > 0 || pl !== 0) cell.classList.add('clickable');
                        cell.innerHTML = `${day}<br>${count} trades<br>${pl.toFixed(2)}`;
                        cell.onclick = () => showDay(dateStr);
                        day++;
                    }
                    row.appendChild(cell);
                }
                tbody.appendChild(row);
                if (day > daysInMonth) break;
            }
            table.appendChild(tbody);
            calendarDiv.appendChild(table);
        }

        function showDay(date) {
            const dayView = document.getElementById('day-view');
            dayView.innerHTML = '';
            const h2 = document.createElement('h2');
            h2.textContent = `Trades for ${date}`;
            dayView.appendChild(h2);

            const dayTrades = trades[date] || [];
            dayTrades.forEach((trade, index) => {
                const tradeDiv = document.createElement('div');
                tradeDiv.id = `trade-${index}`;
                renderTradeDetails(tradeDiv, trade, date, index);
                dayView.appendChild(tradeDiv);
            });

            const addBtn = document.createElement('button');
            addBtn.textContent = 'Add Trade';
            addBtn.onclick = () => addTrade(date);
            dayView.appendChild(addBtn);
        }

        function renderTradeDetails(div, trade, date, index) {
            div.innerHTML = `
                <p><strong>Long/Short:</strong> ${trade.longShort}</p>
                <p><strong>Symbol:</strong> ${trade.symbol}</p>
                <p><strong>Contracts:</strong> ${trade.contracts}</p>
                <p><strong>Time in trade:</strong> ${trade.timeInTrade}</p>
                <p><strong>Time of day:</strong> ${trade.timeOfDay}</p>
                <p><strong>Above/Below VWAP:</strong> ${trade.vwap}</p>
                <p><strong>CBC signal on 10 min:</strong> ${trade.cbc ? 'Yes' : 'No'}</p>
                <p><strong>Entry near 20 EMA on 2 min:</strong> ${trade.ema ? 'Yes' : 'No'}</p>
                <p><strong>Profit/Loss:</strong> ${trade.profitLoss}</p>
                <p><strong>Notes:</strong> ${trade.notes.replace(/\n/g, '<br>')}</p>
            `;
            const editBtn = document.createElement('button');
            editBtn.textContent = 'Edit';
            editBtn.onclick = () => {
                div.innerHTML = '';
                const form = createForm(date, trade, (updated) => {
                    trades[date][index] = updated;
                    saveTrades();
                    renderTradeDetails(div, updated, date, index);
                    renderCalendar();
                    renderSummaries();
                });
                div.appendChild(form);
            };
            const delBtn = document.createElement('button');
            delBtn.textContent = 'Delete';
            delBtn.onclick = () => {
                trades[date].splice(index, 1);
                if (trades[date].length === 0) delete trades[date];
                saveTrades();
                showDay(date);
                renderCalendar();
                renderSummaries();
            };
            div.appendChild(editBtn);
            div.appendChild(delBtn);
        }

        function addTrade(date) {
            const dayView = document.getElementById('day-view');
            const formContainer = document.createElement('div');
            const form = createForm(date, {}, (newTrade) => {
                if (!trades[date]) trades[date] = [];
                trades[date].push(newTrade);
                saveTrades();
                showDay(date);
                renderCalendar();
                renderSummaries();
            });
            formContainer.appendChild(form);
            dayView.appendChild(formContainer);
        }

        function createForm(date, trade = {}, callback) {
            const form = document.createElement('form');
            const fields = [
                {label: 'Long/Short', name: 'longShort', type: 'select', options: ['long', 'short']},
                {label: 'Symbol', name: 'symbol', type: 'text'},
                {label: 'Number of Contracts', name: 'contracts', type: 'number'},
                {label: 'Time in Trade', name: 'timeInTrade', type: 'text'},
                {label: 'Time of Day', name: 'timeOfDay', type: 'time'},
                {label: 'Price Above/Below VWAP', name: 'vwap', type: 'select', options: ['above', 'below']},
                {label: 'CBC Signal on 10 min in Direction', name: 'cbc', type: 'checkbox'},
                {label: 'Entry Near 20 EMA on 2 min', name: 'ema', type: 'checkbox'},
                {label: 'Profit/Loss', name: 'profitLoss', type: 'number', step: '0.01'},
                {label: 'Notes', name: 'notes', type: 'textarea'},
            ];
            fields.forEach(f => {
                const label = document.createElement('label');
                label.textContent = f.label + ': ';
                let input;
                if (f.type === 'select') {
                    input = document.createElement('select');
                    f.options.forEach(opt => {
                        const option = document.createElement('option');
                        option.value = opt;
                        option.textContent = opt;
                        if (trade[f.name] === opt) option.selected = true;
                        input.appendChild(option);
                    });
                } else if (f.type === 'checkbox') {
                    input = document.createElement('input');
                    input.type = 'checkbox';
                    if (trade[f.name]) input.checked = true;
                } else if (f.type === 'textarea') {
                    input = document.createElement('textarea');
                    input.value = trade[f.name] || '';
                } else {
                    input = document.createElement('input');
                    input.type = f.type;
                    if (f.step) input.step = f.step;
                    input.value = trade[f.name] || '';
                }
                input.name = f.name;
                label.appendChild(input);
                form.appendChild(label);
            });
            const submit = document.createElement('button');
            submit.type = 'submit';
            submit.textContent = 'Save';
            form.appendChild(submit);
            form.onsubmit = e => {
                e.preventDefault();
                const newTrade = {};
                fields.forEach(f => {
                    const inp = form.querySelector(`[name="${f.name}"]`);
                    if (f.type === 'checkbox') {
                        newTrade[f.name] = inp.checked;
                    } else {
                        newTrade[f.name] = inp.value;
                    }
                });
                callback(newTrade);
            };
            return form;
        }

        function renderSummaries() {
            const summariesDiv = document.getElementById('summaries');
            summariesDiv.innerHTML = '';
            const now = new Date();
            // YTD
            const ytdStart = new Date(now.getFullYear(), 0, 1);
            const ytdEnd = now;
            const ytd = calculatePeriod(ytdStart, ytdEnd);
            // Month
            const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
            const monthEnd = now;
            const month = calculatePeriod(monthStart, monthEnd);
            // Week
            const dayOfWeek = now.getDay();
            const weekStart = new Date(now);
            weekStart.setDate(now.getDate() - (dayOfWeek === 0 ? 6 : dayOfWeek - 1));
            const weekEnd = new Date(now);
            const week = calculatePeriod(weekStart, weekEnd);

            const h3 = document.createElement('h3');
            h3.textContent = 'Summaries (up to today)';
            summariesDiv.appendChild(h3);
            const weekP = document.createElement('p');
            weekP.textContent = `Week: P/L ${week.totalPL.toFixed(2)}, Profitable days: ${week.profDays}`;
            summariesDiv.appendChild(weekP);
            const monthP = document.createElement('p');
            monthP.textContent = `Month: P/L ${month.totalPL.toFixed(2)}, Profitable days: ${month.profDays}`;
            summariesDiv.appendChild(monthP);
            const ytdP = document.createElement('p');
            ytdP.textContent = `YTD: P/L ${ytd.totalPL.toFixed(2)}, Profitable days: ${ytd.profDays}`;
            summariesDiv.appendChild(ytdP);
        }

        function calculatePeriod(start, end) {
            let totalPL = 0;
            let profDays = 0;
            let current = new Date(start);
            while (current <= end) {
                const dateStr = current.toISOString().slice(0, 10);
                const dayTrades = trades[dateStr];
                if (dayTrades && dayTrades.length > 0) {
                    let dayPL = 0;
                    dayTrades.forEach(t => dayPL += parseFloat(t.profitLoss) || 0);
                    totalPL += dayPL;
                    if (dayPL > 0) profDays++;
                }
                current.setDate(current.getDate() + 1);
            }
            return { totalPL, profDays };
        }

        renderCalendar();
        renderSummaries();
    </script>
</body>
</html>
