<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trade Journal</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; font-size: 16px; }
        #calendar { width: 100%; margin-bottom: 20px; overflow-x: auto; }
        table { border-collapse: collapse; width: 100%; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: center; }
        .day-positive { background-color: #d4edda; }
        .day-negative { background-color: #f8d7da; }
        .day-zero { background-color: white; }
        .clickable { cursor: pointer; }
        #summaries { width: 100%; max-width: 400px; border: 1px solid #ddd; padding: 10px; margin-bottom: 20px; }
        #day-view { border: 1px solid #ddd; padding: 10px; }
        #day-view .card { margin-bottom: 20px; }
        form { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        form label { display: block; margin-bottom: 5px; }
        form textarea { width: 100%; height: 100px; }
        button { margin-right: 5px; padding: 8px 12px; font-size: 16px; }
        
        @media (max-width: 600px) {
            form { grid-template-columns: 1fr; }
            th, td { padding: 8px; font-size: 14px; }
            #calendar { font-size: 14px; }
            button { width: 100%; margin-bottom: 10px; }
        }
        .exit-row { display: flex; gap: 10px; align-items: center; }
        .exit-row input { flex: 1; }
        .remove-exit { cursor: pointer; color: red; }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="mb-4">Trade Journal</h1>
        <div id="summaries" class="card mb-4"></div>
        <div id="calendar" class="mb-4"></div>
        <div id="day-view"></div>
        <button id="exportBtn" class="btn btn-secondary mt-3">Export to CSV</button>
    </div>

    <script>
        let trades = JSON.parse(localStorage.getItem('trades')) || {};

        const multipliers = {
            'ES': 50, 'MES': 5, 'NQ': 20, 'MNQ': 2 // Add more as needed
        };

        function calculatePL(trade) {
            if (!trade.exits || trade.exits.length === 0 || !trade.entryPrice || !trade.symbol) return 0;
            const direction = trade.longShort === 'long' ? 1 : -1;
            let pl = 0;
            const multiplier = multipliers[trade.symbol.toUpperCase()] || 1;
            trade.exits.forEach(exit => {
                const priceDiff = (parseFloat(exit.price) - parseFloat(trade.entryPrice)) * direction;
                pl += priceDiff * parseInt(exit.contracts) * multiplier;
            });
            return pl;
        }

        function saveTrades() {
            localStorage.setItem('trades', JSON.stringify(trades));
        }

        let currentYear = new Date().getFullYear();
        let currentMonth = new Date().getMonth();

        function renderCalendar() {
            const calendarDiv = document.getElementById('calendar');
            calendarDiv.innerHTML = '';

            const nav = document.createElement('div');
            nav.className = 'd-flex justify-content-between mb-3';

            const prev = document.createElement('button');
            prev.className = 'btn btn-primary';
            prev.textContent = 'Prev Month';
            prev.onclick = () => {
                currentMonth--;
                if (currentMonth < 0) { currentMonth = 11; currentYear--; }
                renderCalendar();
            };

            const next = document.createElement('button');
            next.className = 'btn btn-primary';
            next.textContent = 'Next Month';
            next.onclick = () => {
                currentMonth++;
                if (currentMonth > 11) { currentMonth = 0; currentYear++; }
                renderCalendar();
            };

            const todayBtn = document.createElement('button');
            todayBtn.className = 'btn btn-primary';
            todayBtn.textContent = 'Today';
            todayBtn.onclick = () => {
                const now = new Date();
                currentMonth = now.getMonth();
                currentYear = now.getFullYear();
                renderCalendar();
            };

            nav.appendChild(prev);
            nav.appendChild(todayBtn);
            nav.appendChild(next);
            calendarDiv.appendChild(nav);

            const table = document.createElement('table');
            table.className = 'table table-bordered';
            const thead = document.createElement('thead');
            const tr = document.createElement('tr');
            ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].forEach(d => {
                const th = document.createElement('th');
                th.textContent = d;
                tr.appendChild(th);
            });
            thead.appendChild(tr);
            table.appendChild(thead);

            const tbody = document.createElement('tbody');
            const firstDay = new Date(currentYear, currentMonth, 1).getDay();
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            let day = 1;
            for (let i = 0; i < 6; i++) {
                const row = document.createElement('tr');
                for (let j = 0; j < 7; j++) {
                    const cell = document.createElement('td');
                    if ((i === 0 && j < firstDay) || day > daysInMonth) {
                        cell.textContent = '';
                    } else {
                        const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                        const dayTrades = trades[dateStr] || [];
                        const count = dayTrades.length;
                        let pl = 0;
                        dayTrades.forEach(t => pl += calculatePL(t));
                        let className = '';
                        if (pl > 0) className = 'table-success';
                        else if (pl < 0) className = 'table-danger';
                        cell.classList.add(className);
                        if (count > 0 || pl !== 0) cell.classList.add('clickable');
                        cell.innerHTML = `${day}<br>${count} trades<br>${pl.toFixed(2)}`;
                        cell.onclick = () => showDay(dateStr);
                        day++;
                    }
                    row.appendChild(cell);
                }
                tbody.appendChild(row);
                if (day > daysInMonth) break;
            }
            table.appendChild(tbody);
            calendarDiv.appendChild(table);
        }

        function showDay(date) {
            const dayView = document.getElementById('day-view');
            dayView.innerHTML = '';
            const h2 = document.createElement('h2');
            h2.textContent = `Trades for ${date}`;
            dayView.appendChild(h2);

            const dayTrades = trades[date] || [];
            dayTrades.forEach((trade, index) => {
                const tradeDiv = document.createElement('div');
                tradeDiv.className = 'card';
                const cardBody = document.createElement('div');
                cardBody.className = 'card-body';
                tradeDiv.appendChild(cardBody);
                renderTradeDetails(cardBody, trade, date, index);
                dayView.appendChild(tradeDiv);
            });

            const addBtn = document.createElement('button');
            addBtn.className = 'btn btn-success mt-3';
            addBtn.textContent = 'Add Trade';
            addBtn.onclick = () => addTrade(date);
            dayView.appendChild(addBtn);
        }

        function renderTradeDetails(div, trade, date, index) {
            const pl = calculatePL(trade);
            let exitsHtml = '<p><strong>Exits:</strong></p><ul>';
            if (trade.exits && trade.exits.length > 0) {
                trade.exits.forEach(exit => {
                    exitsHtml += `<li>${exit.contracts} contracts at ${exit.price}</li>`;
                });
            } else {
                exitsHtml += '<li>None</li>';
            }
            exitsHtml += '</ul>';
            div.innerHTML = `
                <p><strong>Long/Short:</strong> ${trade.longShort}</p>
                <p><strong>Symbol:</strong> ${trade.symbol}</p>
                <p><strong>Total Contracts:</strong> ${trade.totalContracts}</p>
                <p><strong>Entry Price:</strong> ${trade.entryPrice || 'N/A'}</p>
                ${exitsHtml}
                <p><strong>Time in Trade:</strong> ${trade.timeInTrade}</p>
                <p><strong>Time of Day:</strong> ${trade.timeOfDay}</p>
                <p><strong>Above/Below VWAP:</strong> ${trade.vwap}</p>
                <p><strong>CBC Signal on 10 min:</strong> ${trade.cbc ? 'Yes' : 'No'}</p>
                <p><strong>Entry Near 20 EMA on 2 min:</strong> ${trade.ema ? 'Yes' : 'No'}</p>
                <p><strong>Profit/Loss:</strong> ${pl.toFixed(2)}</p>
                <p><strong>Notes:</strong> ${trade.notes.replace(/\n/g, '<br>')}</p>
            `;
            const editBtn = document.createElement('button');
            editBtn.className = 'btn btn-primary me-2';
            editBtn.textContent = 'Edit';
            editBtn.onclick = () => {
                div.innerHTML = '';
                const form = createForm(date, trade, (updated) => {
                    trades[date][index] = updated;
                    saveTrades();
                    renderTradeDetails(div, updated, date, index);
                    renderCalendar();
                    renderSummaries();
                });
                div.appendChild(form);
            };
            const delBtn = document.createElement('button');
            delBtn.className = 'btn btn-danger';
            delBtn.textContent = 'Delete';
            delBtn.onclick = () => {
                trades[date].splice(index, 1);
                if (trades[date].length === 0) delete trades[date];
                saveTrades();
                showDay(date);
                renderCalendar();
                renderSummaries();
            };
            div.appendChild(editBtn);
            div.appendChild(delBtn);
        }

        function addTrade(date) {
            const dayView = document.getElementById('day-view');
            const formContainer = document.createElement('div');
            formContainer.className = 'card mt-3';
            const cardBody = document.createElement('div');
            cardBody.className = 'card-body';
            const form = createForm(date, {}, (newTrade) => {
                if (!trades[date]) trades[date] = [];
                trades[date].push(newTrade);
                saveTrades();
                showDay(date);
                renderCalendar();
                renderSummaries();
            });
            cardBody.appendChild(form);
            formContainer.appendChild(cardBody);
            dayView.appendChild(formContainer);
        }

        function createForm(date, trade = {}, callback) {
            const form = document.createElement('form');
            const fields = [
                {label: 'Long/Short', name: 'longShort', type: 'select', options: ['long', 'short']},
                {label: 'Symbol', name: 'symbol', type: 'text'},
                {label: 'Total Contracts', name: 'totalContracts', type: 'number'},
                {label: 'Entry Price', name: 'entryPrice', type: 'number', step: '0.01'},
                {label: 'Time in Trade', name: 'timeInTrade', type: 'text'},
                {label: 'Time of Day', name: 'timeOfDay', type: 'time'},
                {label: 'Price Above/Below VWAP', name: 'vwap', type: 'select', options: ['above', 'below']},
                {label: 'CBC Signal on 10 min', name: 'cbc', type: 'checkbox'},
                {label: 'Entry Near 20 EMA on 2 min', name: 'ema', type: 'checkbox'},
                {label: 'Notes', name: 'notes', type: 'textarea'},
            ];
            fields.forEach(f => {
                const label = document.createElement('label');
                label.textContent = f.label + ': ';
                let input;
                if (f.type === 'select') {
                    input = document.createElement('select');
                    input.className = 'form-select';
                    f.options.forEach(opt => {
                        const option = document.createElement('option');
                        option.value = opt;
                        option.textContent = opt;
                        if (trade[f.name] === opt) option.selected = true;
                        input.appendChild(option);
                    });
                } else if (f.type === 'checkbox') {
                    input = document.createElement('input');
                    input.type = 'checkbox';
                    input.className = 'form-check-input';
                    if (trade[f.name]) input.checked = true;
                } else if (f.type === 'textarea') {
                    input = document.createElement('textarea');
                    input.className = 'form-control';
                    input.value = trade[f.name] || '';
                } else {
                    input = document.createElement('input');
                    input.type = f.type;
                    input.className = 'form-control';
                    if (f.step) input.step = f.step;
                    input.value = trade[f.name] || '';
                }
                input.name = f.name;
                label.appendChild(input);
                form.appendChild(label);
            });

            const exitsSection = document.createElement('div');
            exitsSection.innerHTML = '<h5>Exits</h5>';
            const exitsContainer = document.createElement('div');
            exitsContainer.id = 'exits-container';
            let exitIndex = 0;

            function addExitRow(price = '', contracts = '') {
                const row = document.createElement('div');
                row.className = 'exit-row';
                const priceInput = document.createElement('input');
                priceInput.type = 'number';
                priceInput.step = '0.01';
                priceInput.placeholder = 'Exit Price';
                priceInput.value = price;
                priceInput.className = 'form-control';
                const contractsInput = document.createElement('input');
                contractsInput.type = 'number';
                contractsInput.placeholder = 'Contracts';
                contractsInput.value = contracts;
                contractsInput.className = 'form-control';
                const remove = document.createElement('span');
                remove.className = 'remove-exit';
                remove.textContent = 'Remove';
                remove.onclick = () => row.remove();
                row.appendChild(priceInput);
                row.appendChild(contractsInput);
                row.appendChild(remove);
                exitsContainer.appendChild(row);
                exitIndex++;
            }

            const addExitBtn = document.createElement('button');
            addExitBtn.type = 'button';
            addExitBtn.className = 'btn btn-secondary mt-2';
            addExitBtn.textContent = 'Add Exit';
            addExitBtn.onclick = () => addExitRow();

            if (trade.exits && trade.exits.length > 0) {
                trade.exits.forEach(exit => addExitRow(exit.price, exit.contracts));
            } else {
                addExitRow(); // Add one by default
            }

            exitsSection.appendChild(exitsContainer);
            exitsSection.appendChild(addExitBtn);
            form.appendChild(exitsSection);

            const submit = document.createElement('button');
            submit.type = 'submit';
            submit.className = 'btn btn-success mt-3';
            submit.textContent = 'Save';
            form.appendChild(submit);

            form.onsubmit = e => {
                e.preventDefault();
                const newTrade = { exits: [] };
                fields.forEach(f => {
                    const inp = form.querySelector(`[name="${f.name}"]`);
                    if (f.type === 'checkbox') {
                        newTrade[f.name] = inp.checked;
                    } else {
                        newTrade[f.name] = inp.value;
                    }
                });
                const exitRows = exitsContainer.querySelectorAll('.exit-row');
                exitRows.forEach(row => {
                    const price = row.querySelector('input[placeholder="Exit Price"]').value;
                    const contracts = row.querySelector('input[placeholder="Contracts"]').value;
                    if (price && contracts) {
                        newTrade.exits.push({ price, contracts });
                    }
                });
                // Optional: Validate sum of exit contracts <= totalContracts
                const totalExited = newTrade.exits.reduce((sum, e) => sum + parseInt(e.contracts), 0);
                if (totalExited > parseInt(newTrade.totalContracts)) {
                    alert('Total exited contracts exceed total contracts!');
                    return;
                }
                callback(newTrade);
            };
            return form;
        }

        function renderSummaries() {
            const summariesDiv = document.getElementById('summaries');
            summariesDiv.innerHTML = '';
            const now = new Date();
            const ytdStart = new Date(now.getFullYear(), 0, 1);
            const ytd = calculatePeriod(ytdStart, now);
            const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
            const month = calculatePeriod(monthStart, now);
            const dayOfWeek = now.getDay();
            const weekStart = new Date(now);
            weekStart.setDate(now.getDate() - (dayOfWeek === 0 ? 6 : dayOfWeek - 1));
            const week = calculatePeriod(weekStart, now);

            const cardBody = document.createElement('div');
            cardBody.className = 'card-body';
            const h5 = document.createElement('h5');
            h5.className = 'card-title';
            h5.textContent = 'Summaries (up to today)';
            cardBody.appendChild(h5);

            ['Week', 'Month', 'YTD'].forEach((period, i) => {
                const data = [week, month, ytd][i];
                const p = document.createElement('p');
                p.className = 'card-text';
                p.innerHTML = `<strong>${period}:</strong> P/L ${data.totalPL.toFixed(2)}, Profitable days: ${data.profDays}, Win Rate: ${data.winRate.toFixed(1)}%, Expectancy: ${data.expectancy.toFixed(2)}`;
                cardBody.appendChild(p);
            });
            summariesDiv.appendChild(cardBody);
        }

        function calculatePeriod(start, end) {
            let totalPL = 0;
            let profDays = 0;
            let wins = 0;
            let losses = 0;
            let totalTrades = 0;
            let sumWins = 0;
            let sumLosses = 0;
            let current = new Date(start);
            while (current <= end) {
                const dateStr = current.toISOString().slice(0, 10);
                const dayTrades = trades[dateStr];
                if (dayTrades && dayTrades.length > 0) {
                    let dayPL = 0;
                    dayTrades.forEach(t => {
                        const pl = calculatePL(t);
                        dayPL += pl;
                        totalTrades++;
                        if (pl > 0) {
                            wins++;
                            sumWins += pl;
                        } else if (pl < 0) {
                            losses++;
                            sumLosses += Math.abs(pl);
                        }
                    });
                    totalPL += dayPL;
                    if (dayPL > 0) profDays++;
                }
                current.setDate(current.getDate() + 1);
            }
            const winRate = totalTrades > 0 ? (wins / totalTrades) * 100 : 0;
            const avgWin = wins > 0 ? sumWins / wins : 0;
            const avgLoss = losses > 0 ? sumLosses / losses : 0;
            const expectancy = (winRate / 100 * avgWin) - ((1 - winRate / 100) * avgLoss);
            return { totalPL, profDays, winRate, expectancy };
        }

        function exportToCSV() {
            let csv = 'Date,LongShort,Symbol,TotalContracts,EntryPrice,Exits,TimeInTrade,TimeOfDay,VWAP,CBC,EMA,ProfitLoss,Notes\n';
            Object.keys(trades).forEach(date => {
                trades[date].forEach(trade => {
                    const pl = calculatePL(trade);
                    const exitsStr = trade.exits ? trade.exits.map(e => `${e.contracts}@${e.price}`).join('; ') : '';
                    csv += `${date},${trade.longShort},${trade.symbol},${trade.totalContracts},${trade.entryPrice},"${exitsStr}",${trade.timeInTrade},${trade.timeOfDay},${trade.vwap},${trade.cbc ? 'Yes' : 'No'},${trade.ema ? 'Yes' : 'No'},${pl},${trade.notes.replace(/\n/g, ' ')}\n`;
                });
            });
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'trades.csv';
            a.click();
            URL.revokeObjectURL(url);
        }

        document.getElementById('exportBtn').onclick = exportToCSV;

        renderCalendar();
        renderSummaries();
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
